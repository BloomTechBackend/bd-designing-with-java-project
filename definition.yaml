version: 2016-11-18
stack:
  name: ATACurriculumSustainabilityShipmentServiceLambdaStack

  devAccount:
    type: Conduit
    roleArn: arn:aws:iam::568957530115:role/IibsAdminAccess-DO-NOT-DELETE

  applications:
    ATACurriculumSustainabilityShipmentServiceLambda:
      type: sam
      codeURI: ../../
      versionSet: ATACurriculumSustainabilityShipmentServiceLambda/development
      packages:
        ATACurriculumSustainabilityShipmentServiceLambda:
          buildTarget: release
          isApplicationTarget: true
          isBatsParameter: true
      environment:
        variables:
          AWS_REGION: us-west-2
      mountPoints:
      - sourceURI: mounts/events/base_api_request.json
        destinationURI: /tmp/events/base_api_request.json
      - sourceURI: mounts/events/prepare_shipment.json
        destinationURI: /tmp/events/prepare_shipment.json
      networkMappings:
      - name: com.amazon.atacurriculumsustainabilityshipmentservicelambda
        internalPort: 3000
        externalPort: 80
        exposedPort: 1180
        protocol: http
    # Creating this second debug application so participants don't have to come into the definition and comment and
    # uncomment the SAM_DEBUG_PORT to enable debugging
    DebugATACurriculumSustainabilityShipmentServiceLambda:
      type: sam
      codeURI: ../../
      versionSet: ATACurriculumSustainabilityShipmentServiceLambda/development
      packages:
        ATACurriculumSustainabilityShipmentServiceLambda:
          buildTarget: release
          isApplicationTarget: true
          isBatsParameter: true
      environment:
        variables:
          AWS_REGION: us-west-2
          SAM_DEBUG_PORT: "5005"
      mountPoints:
        - sourceURI: mounts/events/base_api_request.json
          destinationURI: /tmp/events/base_api_request.json
        - sourceURI: mounts/events/prepare_shipment.json
          destinationURI: /tmp/events/prepare_shipment.json
      networkMappings:
        - name: com.amazon.atacurriculumsustainabilityshipmentservicelambda
          internalPort: 3000
          externalPort: 80
          exposedPort: 1180
          protocol: http
    HydraTestApp:
      type: hydra
      versionSet: ATACurriculumSustainabilityShipmentServiceLambda/development
      runDefinitionURI: mounts/hydra/runDefinition.json
      packages:
        ATACurriculumSustainabilityShipmentServiceTCTs:
          majorVersion: "C2020July"
          isApplicationTarget: true

steps:
  stop:
    type: custom
    arguments:
      command: rde stack stop
  build:
    type: build
    arguments:
      applications:
        - ATACurriculumSustainabilityShipmentServiceLambda
        - HydraTestApp
  build-lambda:
    type: build
    arguments:
      applications:
        - ATACurriculumSustainabilityShipmentServiceLambda
  build-debug-app:
    type: build
    arguments:
      applications:
        - DebugATACurriculumSustainabilityShipmentServiceLambda
        - HydraTestApp
  build-debug-lambda:
    type: build
    arguments:
      applications:
        - DebugATACurriculumSustainabilityShipmentServiceLambda
  deploy:
    type: deploy
    arguments:
      applications:
        - ATACurriculumSustainabilityShipmentServiceLambda
        - HydraTestApp
  deploy-lambda:
    type: deploy
    arguments:
      applications:
        - ATACurriculumSustainabilityShipmentServiceLambda
  deploy-debug-app:
    type: deploy
    arguments:
      applications:
        - DebugATACurriculumSustainabilityShipmentServiceLambda
        - HydraTestApp
  deploy-debug-lambda:
    type: deploy
    arguments:
      applications:
        - DebugATACurriculumSustainabilityShipmentServiceLambda
  invoke-prepare-shipment:
    type: stackExec
    arguments:
      applications:
        - ATACurriculumSustainabilityShipmentServiceLambda
      scriptURI: "configuration/stack-exec/invoke-api.py"
  debug-invoke-prepare-shipment:
    type: stackExec
    arguments:
      applications:
        - DebugATACurriculumSustainabilityShipmentServiceLambda
      scriptURI: "configuration/stack-exec/invoke-api.py"
  run-all-tests:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-all-preparedness-tests:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.preparedness.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-preparedness-test-one:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.preparedness.one.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-preparedness-test-two-np:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.preparedness.two.nearpeer.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-preparedness-test-two-pb:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.preparedness.two.projectbuddy.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-preparedness-test-two:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.preparedness.two.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-preparedness-test-three:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.preparedness.three.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-all-mastery-tests:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.mastery.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-one:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.mastery.one.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-two-cloudwatch:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.mastery.two.cloudwatch.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-two-local:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.mastery.two.local.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-two:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.mastery.two.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-three-implement:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.mastery.three.implement.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-three-design:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.mastery.three.design.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-three:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.mastery.three.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-four-unique:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.mastery.four.unique.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-four-polybag:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.mastery.four.polybag.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-four:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.mastery.four.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-five-carbon:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.mastery.five.carbon.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-five-design:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.mastery.five.design.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-five-weighted:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.mastery.five.weighted.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-five:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.mastery.five.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-six:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.mastery.six.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-seven:
    type: stackExec
    arguments:
      applications:
        - HydraTestApp
      scriptArguments: -p com.amazon.atacurriculumsustainabilityshipmentservicelambda.mastery.seven.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"

workflows:
  default:
    - stop
    - build-lambda
    - deploy-lambda
  invoke-prepare-shipment:
    - stop
    - build-lambda
    - deploy-lambda
    - invoke-prepare-shipment
  debug-prepare-shipment:
    - stop
    - build-debug-lambda
    - deploy-debug-lambda
    - debug-invoke-prepare-shipment
  all-tasks:
    - stop
    - build
    - deploy
    - run-all-tests
  debug-all-tasks:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-all-tests
  preparedness-tasks:
    - stop
    - build
    - deploy
    - run-all-preparedness-tests
  debug-preparedness-tasks:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-all-preparedness-tests
  preparedness-task1:
    - stop
    - build
    - deploy
    - run-preparedness-test-one
  debug-preparedness-task1:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-preparedness-test-one
  preparedness-task2-np:
    - stop
    - build
    - deploy
    - run-preparedness-test-two-np
  debug-preparedness-task2-np:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-preparedness-test-two-np
  preparedness-task2-pb:
    - stop
    - build
    - deploy
    - run-preparedness-test-two-pb
  debug-preparedness-task2-pb:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-preparedness-test-two-pb
  preparedness-task2:
    - stop
    - build
    - deploy
    - run-preparedness-test-two
  debug-preparedness-task2:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-preparedness-test-two
  preparedness-task3:
    - stop
    - build
    - deploy
    - run-preparedness-test-three
  debug-preparedness-task3:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-preparedness-test-three
  mastery-tasks:
    - stop
    - build
    - deploy
    - run-all-mastery-tests
  debug-mastery-tasks:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-all-mastery-tests
  tct-task1:
    - stop
    - build
    - deploy
    - run-mastery-test-one
  debug-task1:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-mastery-test-one
  tct-task2-local:
    - stop
    - build
    - deploy
    - run-mastery-test-two-local
  debug-task2-local:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-mastery-test-two-local
  tct-task2-cloudwatch:
    - stop
    - build
    - deploy
    - run-mastery-test-two-cloudwatch
  debug-task2-cloudwatch:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-mastery-test-two-cloudwatch
  tct-task2:
    - stop
    - build
    - deploy
    - run-mastery-test-two
  debug-task2:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-mastery-test-two
  tct-task3-implement:
    - stop
    - build
    - deploy
    - run-mastery-test-three-implement
  debug-task3-implement:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-mastery-test-three-implement
  tct-task3-design:
    - stop
    - build
    - deploy
    - run-mastery-test-three-design
  debug-task3-design:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-mastery-test-three-design
  tct-task3:
    - stop
    - build
    - deploy
    - run-mastery-test-three
  debug-task3:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-mastery-test-three
  tct-task4-unique:
    - stop
    - build
    - deploy
    - run-mastery-test-four-unique
  debug-tct-task4-unique:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-mastery-test-four-unique
  tct-task4-polybag:
    - stop
    - build
    - deploy
    - run-mastery-test-four-polybag
  debug-tct-task4-polybag:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-mastery-test-four-polybag
  tct-task4:
    - stop
    - build
    - deploy
    - run-mastery-test-four
  debug-task4:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-mastery-test-four
  tct-task5-carbon:
    - stop
    - build
    - deploy
    - run-mastery-test-five-carbon
  debug-task5-carbon:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-mastery-test-five-carbon
  tct-task5-design:
    - stop
    - build
    - deploy
    - run-mastery-test-five-design
  debug-task5-design:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-mastery-test-five-design
  tct-task5-weighted:
    - stop
    - build
    - deploy
    - run-mastery-test-five-weighted
  debug-task5-weighted:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-mastery-test-five-weighted
  tct-task5:
    - stop
    - build
    - deploy
    - run-mastery-test-five
  debug-task5:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-mastery-test-five
  tct-task6:
    - stop
    - build
    - deploy
    - run-mastery-test-six
  debug-task6:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-mastery-test-six
  tct-task7:
    - stop
    - build
    - deploy
    - run-mastery-test-seven
  debug-task7:
    - stop
    - build-debug-app
    - deploy-debug-app
    - run-mastery-test-seven
